---
description: Работа с PostgreSQL через MCP и локальный клиент
alwaysApply: true
---

# Работа с БД

## Источник подключения
- Основной способ проверки данных: MCP PostgreSQL (конфиг в `.cursor/mcp.json`).
- Если MCP недоступен в среде агента, допустим fallback на локальный клиент `psql` по тому же DSN.

## Политика доступа
- По умолчанию доступ к БД для агента считается read-only.
- `SELECT` и диагностические запросы разрешены всегда.
- Изменяющие запросы (`INSERT/UPDATE/DELETE/DDL`) выполнять только если это явно требуется задачей и зафиксировано в ТЗ.
- Для структурных изменений использовать миграции проекта, а не ad-hoc SQL.

## Минимальные проверки перед выполнением SQL
1. Убедиться, что подключение идёт к ожидаемой БД (`Pipeline`) и нужному хосту.
2. Для smoke/ревью сначала выполнить безопасный `SELECT 1`.
3. Логировать в отчёте: какой DSN использован (без пароля), какие запросы выполнены, какой результат.

## Что проверять в первую очередь
- Наличие целевых таблиц/индексов.
- Актуальность данных для проверяемого `run_id` / `site_id`.
- Инварианты идемпотентности (нет дублей по уникальным ключам).
