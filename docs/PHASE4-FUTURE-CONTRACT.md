# Phase 4: контракт будущих изменений

Документ фиксирует **когда** и **как** переходить к очереди заданий и (при необходимости) к разделению на сервисы. Кодовый скелет в основном репозитории **не закладывается** до прохождения чек-листа go/no-go.

Связанные документы: [AUDIT-IMPLEMENTATION-2026-02-21.md](AUDIT-IMPLEMENTATION-2026-02-21.md), [AUDIT-ARCHITECTURE-SCALABILITY-2026-02-21.md](AUDIT-ARCHITECTURE-SCALABILITY-2026-02-21.md).

---

## 1. Триггеры старта Phase 4 (go/no-go)

Переход к реализации очереди и оркестратора целесообразен **только при выполнении**:

| № | Критерий | Описание |
|---|----------|----------|
| 1 | **2+ источника** | Реально используются минимум два SourceAdapter (например Telegram + ещё один). |
| 2 | **2+ destination** | Реально используются минимум два DestinationAdapter (например локальный экспорт + VK/YouTube/Дзен). |
| 3 | **Оркестратор** | Есть потребность в единой точке планирования/запуска пайплайнов (не только «один скрипт — один канал»). |
| 4 | **SLA / надёжность** | Появились явные требования: повторные прогоны, отказоустойчивость, ограничение по времени выполнения. |

**Go:** все четыре пункта выполнены или близки.  
**No-go:** один источник/один destination, один скрипт без оркестрации — достаточно текущей архитектуры (Phase 1–3).

---

## 2. Целевые гарантии

После введения Phase 4 ожидаются:

- **Idempotency** — повторный запуск одной и той же задачи (по id/ключу) не дублирует эффект (например не дублирует сообщения в export).
- **Retry policy** — явная политика повторов при сбоях (макс. число попыток, backoff, таймауты).
- **DLQ / failed jobs** — неуспешные задания не теряются; есть хранилище/логи для разбора и ручного повтора.

Конкретные форматы (таблица в SQLite, Redis, файлы) — на этапе проектирования, не в этом контракте.

---

## 3. Минимальные интерфейсы (без реализации)

Описание контрактов для будущей реализации. Код этих интерфейсов **не добавляется** в репозиторий до решения «go».

### 3.1 JobStore

- **Назначение:** хранилище заданий (создание, обновление статуса, выборка по статусу/очереди).
- **Минимальный контракт:** создать задание, получить по id, обновить статус (pending / running / done / failed), выборка «следующих» заданий с учётом блокировок/времени.
- **Детали реализации:** не фиксируются (SQLite, Redis, in-memory — на выбор при реализации).

### 3.2 JobRunner

- **Назначение:** исполнение одного задания (источник → получатель или шаг пайплайна).
- **Минимальный контракт:** принять дескриптор задания (source_id, destination_id, параметры), выполнить один прогон, вернуть результат (успех/ошибка, метаданные для retry).
- **Связь с текущим кодом:** использует существующие SourceAdapter и DestinationAdapter.

### 3.3 RetryPolicy

- **Назначение:** решение о повторе при ошибке (сколько раз, с какой задержкой, когда отправить в DLQ).
- **Минимальный контракт:** по коду/типу ошибки и номеру попытки вернуть: retry / no_retry (в DLQ) и опционально задержку до следующей попытки.

---

## 4. Критерии готовности к реализации

Перед написанием кода очереди/оркестратора:

- [ ] Чек-лист go/no-go (раздел 1) пройден.
- [ ] Выбрано хранилище заданий (SQLite / Redis / иное) и способ хранения состояния.
- [ ] Согласованы форматы заданий и статусов с командой/стейкхолдерами.
- [ ] Определено, где хранятся failed jobs (DLQ) и как их перезапускать.

---

## 5. Миграционный план (очерёдность)

1. Ввести интерфейсы JobStore, JobRunner, RetryPolicy в коде (или в отдельном пакете) **после** go.
2. Реализовать первую бэкенд-реализацию JobStore (например SQLite).
3. Подключить существующие SourceAdapter/DestinationAdapter к JobRunner.
4. Добавить retry и DLQ по выбранной RetryPolicy.
5. Физическое разделение на сервисы — только при явных требованиях (несколько команд, разные SLA, масштаб); иначе — один процесс с очередью внутри.

---

## 6. Чек-лист go/no-go (сводка)

| Вопрос | Да / Нет |
|--------|----------|
| Есть 2+ источника (SourceAdapter)? | |
| Есть 2+ получателя (DestinationAdapter)? | |
| Нужен оркестратор (планирование/очередь)? | |
| Есть требования по SLA/повторам/надёжности? | |

**Итог:** если хотя бы один ответ «Нет» — остаёмся на Phase 1–3, контракт не реализуем в коде.

При изменении ответов чек-лист можно пересматривать и при «Go» переходить к разделу 4–5.
