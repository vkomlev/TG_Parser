# WordPress Source — план тестирования и критерии приемки MVP

**Дата:** 2026-02-23  
**Связанные документы:** [wp-source-implementation-plan](wp-source-implementation-plan.md), [wp-source-architecture](wp-source-architecture.md)

---

## 1. Цели тестирования

- Убедиться, что существующий функционал TG не сломан.
- Проверить корректность работы WP sync: запросы к API, маппинг, сохранение в БД, логирование и коды выхода.
- Обеспечить повторяемость и автоматизируемость проверок (unit, integration, smoke).

---

## 2. Unit-тесты

**Область:** логика без реальных HTTP и БД (моки).

| Объект | Что тестировать |
|--------|------------------|
| Маппинг WP JSON → модель | Для фиксированного примера ответа API (post, page, term, user) результат содержит ожидаемые поля и типы. |
| Маппинг модели → единый JSON output | Контракт (source=wp, site_id, slug, …) соблюдён. |
| Расчёт паузы / rate limit | При заданных параметрах (3 req/s) пауза между запросами ≥ 1/3 с. |
| Retry / backoff | При заданных кодах ответа (429, 5xx, timeout) принимается решение retry или нет; задержка соответствует формуле. |
| Валидация конфига | Отсутствие base_url или кредов приводит к понятной ошибке (CONFIG_ERROR или аналог). |

**Инструменты:** pytest (или аналог, согласованный с проектом). Моки — requests/responses или unittest.mock.

**Расположение:** `tests/unit/` или `tests/test_wp_*.py` рядом с существующими smoke-тестами.

---

## 3. Integration-тесты

**Условие:** доступ к тестовому WordPress (или к мок-серверу, отдающему реалистичные ответы REST API) и к тестовой БД (PostgreSQL или SQLite).

| Сценарий | Шаги | Ожидаемый результат |
|----------|------|----------------------|
| Успешный full sync одного сайта | Запуск sync для одного site_id с валидными кредами | В БД появились/обновились записи в wp_sites, wp_authors, wp_terms, wp_content, wp_content_terms; wp_sync_runs содержит запись со status=success и корректными счётчиками. |
| Пагинация | Сайт с числом постов > 100 | Все страницы запрошены, в wp_content количество записей совпадает с общим числом опубликованных постов. |
| Повторный run (идемпотентность) | Два последовательных full sync без изменений на WP | Количество строк в таблицах не изменилось; дубликатов нет; synced_at обновлён во второй run. |
| Ошибка 401 | Неверный Application Password | Лог содержит WP_AUTH_ERROR; exit code 1; в БД либо пусто, либо только запись sync_run со status=failed. |
| Rate limit 429 | Сервер возвращает 429 (или мок) | В логе есть событие rate limit и retry; при успехе после retry — sync завершён; при постоянном 429 — partial/failed и EXIT_PARTIAL или EXIT_FAILURE. |
| Таймаут | Сервер не отвечает в течение timeout | Retry по backoff; после исчерпания — ошибка в логе, run со status partial/failed. |

**Данные:** по возможности использовать один тестовый WP-инстанс с известным набором постов/страниц/терминов; без зависимости от внешних прод-сайтов.

---

## 4. Smoke-тесты

**Цель:** быстрая проверка «поднялось ли приложение и не сломался ли базовый сценарий».

| Тест | Действие | Критерий успеха |
|------|----------|------------------|
| TG без изменений | Запуск существующих smoke_phase1 / phase2 / phase3 (или выборочно) | Все выбранные тесты проходят без регрессии. |
| WP sync dry-run или мок | Запуск команды WP sync с флагом dry-run или с мок-сервером (без записи в прод БД) | Exit code 0 или 2 (если предусмотрен частичный сценарий); в логах есть run_id и корректный summary. |
| WP sync с тестовым сайтом | Один полный sync в тестовую БД | Exit 0; в БД есть записи; summary содержит ожидаемые счётчики. |

**Расположение:** при наличии — отдельный файл `tests/smoke_wp.py` или сценарии в существующей структуре smoke; в CI запускать после unit и перед деплоем.

---

## 5. Критерии приемки MVP

Сводный чек-лист для передачи разработчику и приёмки фичи:

- [ ] **Архитектура:** WP sync выполняется отдельной точкой входа (скрипт или подкоманда), без изменений в поведении команд `channels`, `parse`, `resolve` TG.
- [ ] **Конфиг:** YAML `config/wp-sites.yml` (список сайтов, base_url, name) + переменные окружения для секретов (Application Password); per_page, timeout, retries, rate limit — из конфига или дефолтов.
- [ ] **API:** Реализованы запросы к `/wp/v2/users`, `/wp/v2/posts`, `/wp/v2/pages`, `/wp/v2/categories`, `/wp/v2/tags` с пагинацией и фильтром status=publish. Целевая версия WP: 6.0+.
- [ ] **Маппинг:** Поля slug, author, SEO (yoast_head_json или аналог) маппятся в модель и в единый JSON output; post_content в MVP — только `content.rendered`.
- [ ] **БД:** DDL PostgreSQL применён из `migrations/wp/`; upsert по (site_id, wp_*_id) обеспечивает идемпотентность full sync; при недоступности PostgreSQL возможен fallback на SQLite для dev.
- [ ] **Ошибки и retry:** Timeout 30 s, retries 3, exponential backoff; при 429 — пауза и retry; коды WP_* или общие (AUTH_ERROR, RATE_LIMIT, NETWORK_ERROR) в логах и summary.
- [ ] **Наблюдаемость:** один run_id на весь запуск; в каждой записи/логе — site_id; run_id и error_code в логах и в summary; итоговый summary содержит run_at, run_id, site_id, счётчики, partial_failure.
- [ ] **ContentItem:** интеграция с contracts.py в MVP не входит; только экспорт в БД и единый JSON output.
- [ ] **Коды выхода:** 0 — успех, 1 — фатальная ошибка, 2 — частичный успех (аналогично TG).
- [ ] **Тесты:** Unit-тесты на маппинг и retry/rate limit; хотя бы один интеграционный сценарий (успешный sync); smoke без регрессии TG.
- [ ] **Документация:** Актуальные ссылки между документами wp-source-* и краткая инструкция по настройке WP (Application Password, конфиг) в README или docs.

---

## 6. Регрессия TG

- После внесения изменений в общие модули (errors.py, logging_setup.py, exit_codes.py) обязательно запускать существующие smoke-тесты TG (phase1/2/3 по возможности и session_stability при необходимости).
- В ревью проверять отсутствие изменений в telegram_parser.py и telegram_parser_skill.py, кроме явно оговорённых (например добавление общих кодов ошибок).
