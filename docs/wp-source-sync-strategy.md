# WordPress Source — стратегия синхронизации и обработки ошибок

**Дата:** 2026-02-23  
**Связанные документы:** [wp-source-architecture](wp-source-architecture.md), [wp-source-api-mapping](wp-source-api-mapping.md), [wp-source-data-model-postgres](wp-source-data-model-postgres.md)

---

## 1. Режим синхронизации (MVP)

- **Full sync:** за один запуск загружаются все сущности (users, terms, posts, pages) по фильтру `status=publish` и сохраняются в БД через upsert. Инкрементальная синхронизация (только изменённые с даты) в MVP не предусмотрена.
- **Расписание:** внешнее (OpenClaw). Режим по умолчанию — daily; конфигурируемо (cron-выражение или интервал в конфиге оркестратора).
- **Один run:** один run_id на весь запуск (на один сайт или на все сайты подряд — в зависимости от конфига).

---

## 2. Базовые параметры запросов

| Параметр | Значение | Комментарий |
|----------|----------|-------------|
| per_page | 100 | Максимум для ядра WP REST API |
| timeout | 30 s | На один HTTP-запрос |
| retries | 3 | После неудачи (кроме 4xx кроме 429) |
| rate limit | до 3 req/s на сайт | Пауза между запросами ≥ 1/3 с; при 429 — см. ниже |

---

## 3. Retry и exponential backoff

- **Повторять при:** сетевые ошибки, таймаут, 5xx, 429 (Too Many Requests).
- **Не повторять при:** 400, 401, 403, 404 (после первой попытки считать ошибку финальной для этого запроса).
- **Стратегия:** exponential backoff. Задержка перед попыткой N (N=1,2,3): `delay = min(2^N, 60)` секунд (кап 60 с). После 3 неудачных попыток — зафиксировать ошибку в логе с run_id и error_code, обновить summary (partial_failure или failed в зависимости от того, были ли уже сохранены данные).
- **Область retry:** один HTTP-запрос (одна страница пагинации). При падении запроса страницы 5 постов — повторять только этот запрос; уже загруженные страницы 1–4 не откатывать.

---

## 4. Rate limit (429 и проактивная пауза)

- **Проактивно:** между любыми двумя запросами к одному и тому же site_id — пауза не менее 1/3 с (чтобы не превышать 3 req/s).
- **При ответе 429:** считать заголовок `Retry-After` (если есть); иначе использовать exponential backoff. Выполнить одну повторную попытку после паузы; при повторном 429 — увеличить паузу (например следующая ступень backoff) и повторить до исчерпания retries. В лог писать событие с run_id и error_code RATE_LIMIT / WP_RATE_LIMIT.
- **Допущение:** единый глобальный лимит на сайт (3 req/s); если API возвращает другой лимит в заголовках — можно расширить логику позже.

---

## 5. Таймауты

- **HTTP timeout:** 30 с на каждый запрос (connect + read). При срабатывании — считать попытку неудачной и применять retry.
- **Общий timeout run (опционально):** при необходимости ограничить время одного sync (например 1 час) — конфигурируемый параметр; по истечении — завершить run со статусом partial, записать в summary и выйти с EXIT_PARTIAL. Допущение: в MVP общий timeout можно не вводить и положиться на оркестратор.

---

## 6. Обработка частичного успеха

- Если после части запросов произошла неустранимая ошибка (например 401 после retries) или исчерпаны retries:
  - Уже загруженные и сохранённые данные **не откатывать**.
  - Записать в `wp_sync_runs`: status = `partial`, error_code = соответствующий код.
  - В summary: partial_failure = true, указать количество успешно загруженных posts/pages/terms и описание последней ошибки.
  - Код выхода процесса: EXIT_PARTIAL (2).
- Если не удалось выполнить ни одного успешного запроса (например сразу 401): status = `failed`, exit code = EXIT_FAILURE (1).

---

## 7. Идемпотентность full sync

- Каждый run перезаписывает данные по первичному ключу (site_id, wp_*_id [и taxonomy для terms]). Повторный запуск с теми же данными даёт тот же результат; дубликатов не создаётся.
- Записи, которые перестали возвращаться API (удалены или сняты с публикации), в MVP не удаляются из БД автоматически (см. [data-model](wp-source-data-model-postgres.md)); при необходимости — отдельная политика (флаг `--prune-missing` или отдельная команда).

---

## 8. Логирование и summary

- **Старт run:** запись в app log и при необходимости в таблицу wp_sync_runs (status=running); событие с run_id, site_id, параметрами.
- **Каждая ошибка retry:** уровень WARNING/ERROR, run_id, error_code, attempt, url или тип сущности.
- **429 / rate limit:** событие с run_id, error_code, Retry-After или пауза.
- **Завершение run:** запись в wp_sync_runs (finished_at, status, error_code, счётчики); summary в лог (run_at, run_id, site_id, posts_count, pages_count, terms_count, authors_count, partial_failure, error_code).
- Формат summary — согласован с существующим стилем TG (run_at, run_id, ключевые счётчики, partial_failure, export_dir или аналог).

---

## 9. Коды ошибок (расширение errors.py)

Рекомендуемые константы для WP (добавить в `errors.py`, не трогая существующие):

- `WP_AUTH_ERROR` — 401/403 при обращении к API.
- `WP_RATE_LIMIT` — 429 или превышение лимита запросов.
- `WP_NETWORK_ERROR` — таймаут, соединение отклонено, 5xx.
- `WP_DATA_FORMAT_ERROR` — неожиданная структура ответа или невалидный JSON.

При необходимости можно использовать общие коды (AUTH_ERROR, RATE_LIMIT, NETWORK_ERROR, DATA_FORMAT_ERROR) с префиксом в сообщении «WP»; отдельные константы удобны для фильтрации логов по источнику.
